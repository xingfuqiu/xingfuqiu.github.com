<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 通过崩溃地址找出Delphi源码的出错行 · 邱兴福</title><meta name="description" content="通过崩溃地址找出Delphi源码的出错行 - xingfuqiu"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://www.qxyer.com/atom.xml" title="邱兴福"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/xingfuqiu" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">通过崩溃地址找出Delphi源码的出错行</h1><div class="post-info">May 23, 2012</div><div class="post-content"><h3 id="什么是MAP文件"><a href="#什么是MAP文件" class="headerlink" title="什么是MAP文件"></a>什么是MAP文件</h3><p>   什么是 MAP 文件？简单地讲， MAP 文件是程序的全局符号、源文件和代码行号信息的唯一的文本表示方法，它可以在任何地方、任何时候使用，不需要有额外的程序进行支持。而且，这是唯一能找出程序崩溃的地方的救星。</p>
<p>如果要查找代码行号，需要使用下面的公式做一些十六进制的减法运算：</p>
<p>崩溃行偏移 = 崩溃地址（Crash Address） - 基地址（ImageBase Address） - 0x1000</p>
<p>为什么要这样做呢？我们得到的崩溃地址都是由 偏移地址+ 基地址得来的，所以在计算行号的时候要把基地址减去，一般情况下，基地址的值是 0x00400000 。另外，由于一般的 PE 文件的代码段都是从 0x1000 偏移开始的，所以也必须减去 0x1000 。</p>
<h3 id="Delphi-下生成MAP文件的方法"><a href="#Delphi-下生成MAP文件的方法" class="headerlink" title="Delphi 下生成MAP文件的方法"></a>Delphi 下生成MAP文件的方法</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">project-&gt;options-&gt;Linker-&gt;Map file 选择detailed.</span><br></pre></td></tr></table></figure>
<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">procedure</span> <span class="title">TForm1</span>.<span class="title">Button1Click</span><span class="params">(Sender: TObject)</span>;</span></span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">    I,   J:   Integer;</span><br><span class="line">    p:   PChar;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    I   :=   <span class="number">10</span>;</span><br><span class="line">    J   :=   <span class="number">0</span>;</span><br><span class="line">    p   :=   <span class="keyword">nil</span>;</span><br><span class="line">    p^   :=   <span class="string">'A'</span>;   <span class="comment">//   36行.  这里会报错</span></span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
<p>运行时会抱错</p>
<p><img src="http://p.blog.csdn.net/images/p_blog_csdn_net/taoff/error.bmp" alt="邱兴福"></p>
<p>这里可以发现出错地址是:<code>$00401A51</code></p>
<p>根据: 崩溃行偏移 = 崩溃地址（Crash Address） - 基地址（ImageBase Address） - 0x1000</p>
<p>=$00401A51 - $00400000 -$1000</p>
<p>=$00000A51</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">用记事本打开生成的MAP文件</span><br><span class="line">Line numbers <span class="keyword">for</span> Unit1(Unit1.pas) segment .text</span><br><span class="line">32 0001:00000A48    35 0001:00000A49     36 0001:00000A4E    37 0001:00000A54</span><br><span class="line">40 0001:00000A58    42 0001:00000A7D    43 0001:00000A8E    44 0001:00000ABD</span><br><span class="line">45 0001:00000AEE    49 0001:00000AF8    50 0001:00000B10    52 0001:00000B44</span><br><span class="line">52 0001:00000B4B</span><br></pre></td></tr></table></figure>
<p>那么,通过在MAP文件里查找小于或等于$00000A51的最大值就是,我们要得到的崩溃行偏移.<br>这样得到出错行在, Unit1单元的36行.<br>正好是这行：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p^ := <span class="string">'A'</span>;   //36行.  这里会报错</span><br></pre></td></tr></table></figure></p>
</div></article></div></main><footer><div class="paginator"><a href="/2012/05/23/delphi-listview-drawitem/" class="prev">PREV</a><a href="/2012/05/14/win7-delphi7-install/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2018 <a href="http://www.qxyer.com">xingfuqiu</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>